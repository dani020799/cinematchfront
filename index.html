<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cinematch - Your Movie Recommendation Platform</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        /* Ensure content doesn't get hidden under fixed header */
        .content-wrapper { padding-top: 4rem; }
        /* Hide scrollbars while keeping scroll functionality */
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-700 via-indigo-600 to-cyan-500 min-h-screen text-white">
    <!-- Header placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main content -->
    <div class="content-wrapper">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Welcome to Cinematch</h2>
                <p class="text-gray-700 mt-2">Your personalized movie and TV show recommendation platform.</p>
            </div>

            <!-- 1) Trending Now -->
            <section class="bg-white/90 backdrop-blur-md rounded-xl shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Trending Now</h3>
                <div class="overflow-x-auto overflow-y-hidden snap-x snap-mandatory scroll-smooth touch-pan-x cursor-grab" data-hscroll>
                    <div id="trending-row" class="flex flex-nowrap gap-x-4 pb-2 min-w-max"></div>
                </div>
            </section>

            <!-- 2) Top Rated with toggle -->
            <section class="bg-white/90 backdrop-blur-md rounded-xl shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xl font-semibold text-gray-800">Top Rated</h3>
                    <div class="inline-flex rounded-lg border border-gray-200/80 overflow-hidden bg-white/60" role="group" aria-label="Top Rated Toggle">
                        <button id="btn-top-movies" type="button" class="px-3 py-1.5 text-sm font-medium bg-indigo-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-300">Movies</button>
                        <button id="btn-top-tv" type="button" class="px-3 py-1.5 text-sm font-medium bg-transparent text-gray-700 hover:bg-white/70 focus:outline-none">TV Shows</button>
                    </div>
                </div>
                <div class="overflow-x-auto overflow-y-hidden snap-x snap-mandatory scroll-smooth touch-pan-x cursor-grab" data-hscroll>
                    <div id="top-rated-row" class="flex flex-nowrap gap-x-4 pb-2 min-w-max"></div>
                </div>
            </section>

            <!-- 3) Now Playing -->
            <section class="bg-white/90 backdrop-blur-md rounded-xl shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Now Playing</h3>
                <div class="overflow-x-auto overflow-y-hidden snap-x snap-mandatory scroll-smooth touch-pan-x cursor-grab" data-hscroll>
                    <div id="now-playing-row" class="flex flex-nowrap gap-x-4 pb-2 min-w-max"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Provide header interactions for dynamically-inserted header.html
        function initHeaderInteractions() {
            const userDropdown = document.querySelector('.user-dropdown');
            if (!userDropdown) return;

            if (typeof window.toggleUserDropdown !== 'function') {
                window.toggleUserDropdown = function () {
                    const isActive = userDropdown.classList.contains('active');
                    if (isActive) {
                        userDropdown.classList.remove('active');
                        document.body.classList.remove('dropdown-open');
                    } else {
                        userDropdown.classList.add('active');
                        document.body.classList.add('dropdown-open');
                    }
                };
            }

            if (!window.__headerDropdownBound) {
                document.addEventListener('click', function (event) {
                    if (!userDropdown.contains(event.target)) {
                        userDropdown.classList.remove('active');
                        document.body.classList.remove('dropdown-open');
                    }
                });

                document.addEventListener('keydown', function (event) {
                    if (event.key === 'Escape') {
                        userDropdown.classList.remove('active');
                        document.body.classList.remove('dropdown-open');
                    }
                });

                window.__headerDropdownBound = true;
            }

            const userButton = userDropdown.querySelector('.user-button');
            if (userButton) {
                userButton.setAttribute('aria-expanded', 'false');
                userButton.setAttribute('aria-haspopup', 'true');

                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        if (mutation.attributeName === 'class') {
                            const isActive = userDropdown.classList.contains('active');
                            userButton.setAttribute('aria-expanded', String(isActive));
                        }
                    });
                });

                observer.observe(userDropdown, { attributes: true, attributeFilter: ['class'] });
            }
        }

        async function loadHeader() {
            try {
                const cacheBuster = `v=${Date.now()}`;
                const response = await fetch(`header.html?${cacheBuster}`, { cache: 'no-store' });
                if (!response.ok) throw new Error(`Failed to load header: ${response.status} ${response.statusText}`);
                const headerContent = await response.text();
                document.getElementById('header-placeholder').innerHTML = headerContent;
                initHeaderInteractions();
            } catch (error) {
                console.error('Error loading header:', error);
                document.getElementById('header-placeholder').innerHTML = '<div class="bg-red-100 text-red-700 p-4">Failed to load header. Please hard refresh (Ctrl+F5) and try again.</div>';
            }
        }

        // ===== Media card rendering =====
        let __mediaCardHTML = null;
        async function getMediaCardHTML() {
            if (__mediaCardHTML) return __mediaCardHTML;
            const cacheBuster = `v=${Date.now()}`;
            const res = await fetch(`media-card.html?${cacheBuster}`, { cache: 'no-store' });
            if (!res.ok) throw new Error(`Failed to load media-card.html: ${res.status}`);
            __mediaCardHTML = await res.text();
            return __mediaCardHTML;
        }

        function createCardElement(cardHTML) {
            const t = document.createElement('template');
            t.innerHTML = cardHTML.trim();
            const card = t.content.firstElementChild;
            if (card) {
                // Make compact & responsive; ignore template sizing
                card.classList.remove('w-full', 'max-w-[12rem]');
                card.classList.add('flex-none', 'w-[160px]', 'sm:w-[176px]', 'md:w-[192px]', 'snap-start');
                // Use the template's real image; add graceful fallback only if it fails
                const img = card.querySelector('img');
                if (img) {
                    img.referrerPolicy = 'no-referrer';
                    img.addEventListener('error', () => {
                        img.src = 'https://placehold.co/400x600?text=Image';
                    }, { once: true });
                }
            }
            return card;
        }

        async function renderCards(containerId, count = 20) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const cardHTML = await getMediaCardHTML();
            for (let i = 0; i < count; i++) {
                const card = createCardElement(cardHTML);
                if (card) container.appendChild(card);
            }
        }

        // ===== Top Rated toggle =====
        function setToggleActive(buttonEl, active) {
            const activeClasses = ['bg-indigo-600', 'text-white'];
            const inactiveClasses = ['bg-transparent', 'text-gray-700'];
            if (active) {
                buttonEl.classList.add(...activeClasses);
                buttonEl.classList.remove(...inactiveClasses);
            } else {
                buttonEl.classList.remove(...activeClasses);
                buttonEl.classList.add(...inactiveClasses);
            }
        }

        function initTopRatedToggle() {
            const btnMovies = document.getElementById('btn-top-movies');
            const btnTV = document.getElementById('btn-top-tv');
            if (!btnMovies || !btnTV) return;

            // Default state
            setToggleActive(btnMovies, true);
            setToggleActive(btnTV, false);

            btnMovies.addEventListener('click', async () => {
                setToggleActive(btnMovies, true);
                setToggleActive(btnTV, false);
                await renderCards('top-rated-row', 20);
            });

            btnTV.addEventListener('click', async () => {
                setToggleActive(btnMovies, false);
                setToggleActive(btnTV, true);
                await renderCards('top-rated-row', 20);
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function () {
            loadHeader();
            // initial renders
            await Promise.all([
                renderCards('trending-row', 20),
                renderCards('top-rated-row', 20),
                renderCards('now-playing-row', 20)
            ]);
            initTopRatedToggle();
            enhanceHorizontalScroll();
        });
    </script>
</body>
</html>

<script>
function enhanceHorizontalScroll() {
    document.querySelectorAll('[data-hscroll]').forEach((el) => {
        if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');

        // Force horizontal-only scrolling inside the container
        el.addEventListener(
            'wheel',
            (e) => {
                if (e.deltaY !== 0) {
                    el.scrollLeft += e.deltaY; // map vertical to horizontal
                    e.preventDefault();
                    return;
                }
                if (e.deltaX !== 0) {
                    el.scrollLeft += e.deltaX;
                    e.preventDefault();
                }
            },
            { passive: false }
        );

        // Keyboard arrows
        el.addEventListener('keydown', (e) => {
            const step = Math.max(160, Math.floor(el.clientWidth * 0.9));
            if (e.key === 'ArrowRight') {
                el.scrollBy({ left: step, behavior: 'smooth' });
                e.preventDefault();
            } else if (e.key === 'ArrowLeft') {
                el.scrollBy({ left: -step, behavior: 'smooth' });
                e.preventDefault();
            }
        });

        // Drag-to-scroll (pointer events)
        let isDown = false;
        let startX = 0;
        let startScroll = 0;
        el.addEventListener('pointerdown', (e) => {
            isDown = true;
            startX = e.clientX;
            startScroll = el.scrollLeft;
            el.setPointerCapture(e.pointerId);
            el.classList.add('cursor-grabbing');
        });
        el.addEventListener('pointermove', (e) => {
            if (!isDown) return;
            const dx = e.clientX - startX;
            el.scrollLeft = startScroll - dx;
        });
        const stopDrag = () => {
            if (!isDown) return;
            isDown = false;
            el.classList.remove('cursor-grabbing');
        };
        el.addEventListener('pointerup', stopDrag);
        el.addEventListener('pointercancel', stopDrag);
        el.addEventListener('mouseleave', stopDrag);
    });
}
</script>
